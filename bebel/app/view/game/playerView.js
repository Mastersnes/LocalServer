define(["jquery","underscore","app/utils/utils","app/utils/colisionUtils","app/utils/moveEngine"],function(c,k,e,g,h){return function(f){this.acceleration={x:0,y:0};this.position={x:0,y:0};this.flag={move:0,point:0,deathNb:0,dead:!1,glisse:!1};this.save={position:null,lieu:null,stage:null,point:0,deathNb:0};this.delay=[];this.alreadyLoad=!1;this.init=function(a){this.el=".game";this.stage=a;this.delay.refresh=0;this.moveEngine=new h};this.load=function(a){a&&(this.save=a,this.position.x=this.save.position.x,
this.position.y=this.save.position.y,this.flag.point=this.save.point,this.flag.deathNb=this.save.deathNb)};this.render=function(){c(".game .stage").append(f.createElement({id:"player",x:this.position.x,y:this.position.y}));this.alreadyLoad||this.makeEvents()};this.stopSound=function(a){this.stage.mediatheque.stopSound(a)};this.playSound=function(a){this.stage.mediatheque.playSound(a)};this.refresh=function(){this.delay.refresh++;var a=!1,b=1;this.moveEngine.flag.cours&&(b=2);this.delay.refresh>b&&
(this.delay.refresh=0,a=!0);this.moveEngine.move(this.acceleration,this.flag.move);b=g.check(this.acceleration,this.position,this.stage.map,this);!b.y||b.y.haute?(this.moveEngine.flag.tombe=!0,c("#player").addClass("saute")):(this.moveEngine.flag.tombe=!1,c("#player").removeClass("saute"));b.x&&b.x.action&&b.x.action.useX&&b.x.action.useX(this);if(b.y&&b.y.action){var d=b.y.action;d.dom.attr("playSound")||(d.dom.attr("playSound",!0),this.playSound(b.y.sound));d.useY&&d.useY(this)}this.moveEngine.oriente(this.flag.move);
a&&!b.x&&b.y&&this.moveEngine.marche(this.flag.move);c("#player").css({left:this.position.x+"px",top:this.position.y+"px"});730<=this.position.y&&(this.flag.dead=!0)};this.gagne=function(){this.stage.gagne()};this.reset=function(){this.save.position&&(this.position.x=this.save.position.x,this.position.y=this.save.position.y)};this.savePosition=function(a,b){a&&b&&(this.save.lieu=a,this.save.stage=b);this.save.position=e.clone(this.position);this.save.point=this.flag.point;this.save.deathNb=this.flag.deathNb;
console.log("save : ",this.save);window.localStorage.setItem(e.name,e.encode(JSON.stringify(this.save)))};this.makeEvents=function(){this.alreadyLoad=!0;var a=this;c(document).keydown(function(b){b=b.keyCode||b.which;console.log(b);switch(b){case 39:a.flag.glisse||(a.flag.move=1);break;case 37:a.flag.glisse||(a.flag.move=-1);break;case 32:case 38:a.moveEngine.flag.tombe||a.moveEngine.saute();break;case 16:a.moveEngine.flag.cours=!0;break;case 20:a.moveEngine.flag.lockCours?(a.moveEngine.flag.cours=
!1,a.moveEngine.flag.lockCours=!1):(a.moveEngine.flag.cours=!0,a.moveEngine.flag.lockCours=!0);break;case 27:a.stage.togglePause(a.save,a.flag.point,a.flag.deathNb)}});c(document).keyup(function(b){switch(b.keyCode||b.which){case 39:case 37:a.flag.glisse||(a.flag.move=0);break;case 16:a.moveEngine.flag.lockCours||(a.moveEngine.flag.cours=!1)}})};this.init(f)}});